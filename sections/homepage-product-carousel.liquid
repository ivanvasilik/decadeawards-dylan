{%- comment -%}
  Homepage Product Carousel - Decade Awards
  Featured collection carousel with modern styling
{%- endcomment -%}

{{ 'section-homepage-product-carousel.css' | asset_url | stylesheet_tag }}
{{ 'custom-product-cards.css' | asset_url | stylesheet_tag }}

{%- assign collection = collections[section.settings.collection] -%}

<section class="da-carousel-section" style="background: {{ section.settings.background_color }};">
  <div class="da-carousel-section__container">
    <div class="da-carousel-section__header">
      <div class="da-carousel-section__header-content">
        {%- if section.settings.subheading != blank -%}
          <span class="da-carousel-section__subheading">{{ section.settings.subheading }}</span>
        {%- endif -%}
        <h2 class="da-carousel-section__heading">{{ section.settings.heading }}</h2>
      </div>

      <div class="da-carousel-section__nav">
        <button class="da-carousel-section__nav-btn" data-carousel-prev aria-label="Previous">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="da-carousel-section__nav-btn" data-carousel-next aria-label="Next">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
        {%- if section.settings.show_view_all and collection != blank -%}
          <a href="{{ collection.url }}" class="da-carousel-section__view-all">
            View All
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </a>
        {%- endif -%}
      </div>
    </div>

    <div class="da-carousel" data-product-carousel>
      <div class="da-carousel__track" data-carousel-track>
        {%- if collection != blank -%}
          {%- for product in collection.products limit: section.settings.products_to_show -%}
            <div class="da-carousel__slide">
              <div class="product-card-wrapper">
                {% render 'card-product',
                  card_product: product,
                  media_aspect_ratio: 'square',
                  show_secondary_image: false,
                  show_vendor: false,
                  show_rating: false,
                  section_id: section.id
                %}
              </div>
            </div>
          {%- endfor -%}
        {%- else -%}
          {%- for i in (1..8) -%}
            <div class="da-carousel__slide">
              <div class="da-carousel__placeholder-card">
                <div class="da-carousel__placeholder-image">
                  {{ 'product-1' | placeholder_svg_tag }}
                </div>
                <div class="da-carousel__placeholder-content">
                  <div class="da-carousel__placeholder-title"></div>
                  <div class="da-carousel__placeholder-price"></div>
                </div>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>
    </div>

    {% comment %} <div class="da-carousel__dots" data-carousel-dots></div> {% endcomment %}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-product-carousel]').forEach(carousel => {
      const track = carousel.querySelector('[data-carousel-track]');
      const slides = track.querySelectorAll('.da-carousel__slide');
      const prevBtn = carousel.closest('.da-carousel-section').querySelector('[data-carousel-prev]');
      const nextBtn = carousel.closest('.da-carousel-section').querySelector('[data-carousel-next]');
      const dotsContainer = carousel.closest('.da-carousel-section').querySelector('[data-carousel-dots]');

      let currentIndex = 0;
      const slidesPerView = window.innerWidth < 750 ? 2 : window.innerWidth < 990 ? 3 : {{ section.settings.columns_desktop }};
      const totalSlides = slides.length;
      const maxIndex = Math.max(0, totalSlides - slidesPerView);

      // Create dots
      const dotCount = maxIndex + 1;
      for (let i = 0; i < dotCount; i++) {
        const dot = document.createElement('button');
        dot.className = 'da-carousel__dot' + (i === 0 ? ' da-carousel__dot--active' : '');
        dot.addEventListener('click', () => goToSlide(i));
        dotsContainer.appendChild(dot);
      }
      const dots = dotsContainer.querySelectorAll('.da-carousel__dot');

      function goToSlide(index) {
        currentIndex = Math.max(0, Math.min(index, maxIndex));
        const slideWidth = slides[0].offsetWidth + parseInt(getComputedStyle(track).gap || 0);
        track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;

        dots.forEach((dot, i) => {
          dot.classList.toggle('da-carousel__dot--active', i === currentIndex);
        });
      }

      prevBtn?.addEventListener('click', () => goToSlide(currentIndex - 1));
      nextBtn?.addEventListener('click', () => goToSlide(currentIndex + 1));

      // Touch support
      let touchStartX = 0;
      let touchEndX = 0;

      track.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      track.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        if (touchStartX - touchEndX > 50) goToSlide(currentIndex + 1);
        if (touchEndX - touchStartX > 50) goToSlide(currentIndex - 1);
      }, { passive: true });
    });
  });
</script>

{% schema %}
{
  "name": "Product Carousel",
  "tag": "section",
  "class": "section-product-carousel",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f8f9fa"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 4,
      "max": 16,
      "step": 1,
      "default": 10
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns on desktop",
      "min": 3,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show 'View all' button",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Product Carousel",
      "settings": {
        "heading": "Fantasy Football Trophies",
        "subheading": "Fan Favorites"
      }
    }
  ]
}
{% endschema %}
